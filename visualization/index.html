<!DOCTYPE html>
<html>

<head>
    <title>RF Battlespace Awareness ‚Äì Live TDOA Demo</title>
    <script src="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Cesium.js"></script>
    <link href="https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Widgets/widgets.css" rel="stylesheet">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            width: 100%;
            height: 100%;
            background: #000;
            overflow: hidden;
            font-family: monospace;
            color: #00ff41;
        }

        #cesiumContainer {
            width: 100%;
            height: 100%;
            margin: 0;
            padding: 0;
            overflow: hidden;
        }

        #info {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(0, 0, 0, 0.8);
            padding: 12px;
            border: 1px solid #00ff41;
            z-index: 1000;
        }

        #controls {
            position: absolute;
            bottom: 20px;
            right: 20px;
            z-index: 1000;
        }

        button {
            background: rgba(0, 0, 0, 0.8);
            color: #00ff41;
            border: 2px solid #00ff41;
            padding: 10px 20px;
            font-family: monospace;
            font-size: 14px;
            cursor: pointer;
            margin: 5px;
            transition: all 0.3s;
        }

        button:hover {
            background: rgba(0, 255, 65, 0.2);
            border-color: #00ff00;
            color: #00ff00;
        }

        button:active {
            background: rgba(0, 255, 65, 0.4);
        }
    </style>
</head>

<body>
    <div id="cesiumContainer"></div>
    <div id="info">RF Battlespace Awareness ‚Äì Real-time TDOA<br><span id="status">Initializing...</span></div>
    <div id="controls">
        <button onclick="focusOnFix()">üéØ Focus on Fix</button>
        <button onclick="resetView()">üåç Reset View</button>
    </div>

    <script>
        // Better Earth visualization with atmosphere
        const viewer = new Cesium.Viewer('cesiumContainer', {
            baseLayer: Cesium.ImageryLayer.fromProviderAsync(
                Cesium.TileMapServiceImageryProvider.fromUrl(
                    Cesium.buildModuleUrl("Assets/Textures/NaturalEarthII")
                )
            ),
            terrainProvider: new Cesium.EllipsoidTerrainProvider(),
            skyBox: new Cesium.SkyBox({
                sources: {
                    positiveX: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_px.jpg',
                    negativeX: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_mx.jpg',
                    positiveY: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_py.jpg',
                    negativeY: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_my.jpg',
                    positiveZ: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_pz.jpg',
                    negativeZ: 'https://cesium.com/downloads/cesiumjs/releases/1.123/Build/Cesium/Assets/Textures/SkyBox/tycho2t3_80_mz.jpg'
                }
            }),
            skyAtmosphere: new Cesium.SkyAtmosphere(),
            timeline: false,
            animation: false,
            baseLayerPicker: false,
            geocoder: false,
            homeButton: false,
            sceneModePicker: false,
            navigationHelpButton: false,
            selectionIndicator: false,
            infoBox: false,
            fullscreenButton: false
        });

        // Enable lighting and atmosphere
        viewer.scene.globe.enableLighting = true;
        viewer.scene.globe.showGroundAtmosphere = true;

        document.getElementById('status').innerHTML = 'Ready ‚Äì loading fix...';

        let currentFixData = { lat: 0, lon: 0 };
        let cameraInitialized = false;

        async function loadFix() {
            try {
                const resp = await fetch('/fix');
                if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
                const data = await resp.json();

                viewer.entities.removeAll();

                // TRUTH (always red) - Make it highly visible
                const truthPos = Cesium.Cartesian3.fromDegrees(data.emitter.lon, data.emitter.lat, data.emitter.alt);
                viewer.entities.add({
                    position: truthPos,
                    point: {
                        pixelSize: 20,
                        color: Cesium.Color.RED,
                        outlineColor: Cesium.Color.WHITE,
                        outlineWidth: 3
                    },
                    label: {
                        text: 'EMITTER (TRUTH)',
                        fillColor: Cesium.Color.RED,
                        outlineColor: Cesium.Color.BLACK,
                        outlineWidth: 2,
                        pixelOffset: new Cesium.Cartesian2(0, -35),
                        font: '14px monospace bold',
                        style: Cesium.LabelStyle.FILL_AND_OUTLINE
                    }
                });

                // SATELLITES (cyan with lines to emitter)
                data.satellites.forEach((sat, idx) => {
                    const satPos = Cesium.Cartesian3.fromDegrees(sat.lon, sat.lat, sat.alt);

                    // Satellite marker
                    viewer.entities.add({
                        position: satPos,
                        point: { pixelSize: 12, color: Cesium.Color.CYAN, outlineColor: Cesium.Color.WHITE, outlineWidth: 2 },
                        label: {
                            text: sat.name,
                            fillColor: Cesium.Color.CYAN,
                            pixelOffset: new Cesium.Cartesian2(0, -20),
                            font: '12px monospace'
                        }
                    });

                    // Line from satellite to emitter (to visualize geometry)
                    viewer.entities.add({
                        polyline: {
                            positions: [satPos, truthPos],
                            width: 1,
                            material: Cesium.Color.CYAN.withAlpha(0.3)
                        }
                    });
                });

                // Color by CEP
                let color, outline;
                if (data.cep95 < 200) { color = Cesium.Color.LIME; outline = Cesium.Color.BLACK; }
                else if (data.cep95 < 1000) { color = Cesium.Color.YELLOW; outline = Cesium.Color.BLACK; }
                else { color = Cesium.Color.RED; outline = Cesium.Color.WHITE; }

                viewer.entities.add({
                    position: Cesium.Cartesian3.fromDegrees(data.lon, data.lat, 200),
                    point: { pixelSize: 16, color: color, outlineColor: outline, outlineWidth: 3 },
                    label: { text: 'FIX', fillColor: color, pixelOffset: new Cesium.Cartesian2(0, -30) },
                    ellipse: {
                        semiMinorAxis: data.cep95,
                        semiMajorAxis: data.cep95,
                        height: 100,
                        extrudedHeight: 300,
                        material: color.withAlpha(0.25),
                        outline: true,
                        outlineColor: color
                    }
                });

                const error_m = Math.round(Math.sqrt((data.lat - data.emitter.lat) ** 2 + (data.lon - data.emitter.lon) ** 2) * 111000);
                const gdop = (data.cep95 / 50).toFixed(1);
                document.getElementById('status').innerHTML =
                    `Fix: ${data.lat.toFixed(4)}¬∞N ${data.lon.toFixed(4)}¬∞E | CEP95: ${data.cep95.toFixed(0)}m | Error: ${error_m}m | GDOP: ${gdop} | Sats: ${data.satellites.length}`;

                // Store current fix position for focus button
                currentFixData = { lat: data.lat, lon: data.lon };

                // Set camera ONCE on first load - then NEVER touch it again
                if (!cameraInitialized) {
                    viewer.camera.setView({
                        destination: Cesium.Cartesian3.fromDegrees(data.emitter.lon, data.emitter.lat, 2000000), // 2000km altitude
                        orientation: {
                            heading: 0.0,
                            pitch: Cesium.Math.toRadians(-30),
                            roll: 0.0
                        }
                    });
                    cameraInitialized = true;
                }
            } catch (e) {
                console.error(e);
            }
        }

        // Simple zoom to fix location
        function focusOnFix() {
            if (!currentFixData.lat || !currentFixData.lon) return;
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(currentFixData.lon, currentFixData.lat, 100000),
                orientation: {
                    heading: 0,
                    pitch: Cesium.Math.toRadians(-45),
                    roll: 0
                },
                duration: 1.5
            });
        }

        // Reset to overview
        function resetView() {
            if (!currentFixData.lat || !currentFixData.lon) return;
            viewer.camera.flyTo({
                destination: Cesium.Cartesian3.fromDegrees(currentFixData.lon, currentFixData.lat, 2000000),
                orientation: {
                    heading: 0,
                    pitch: Cesium.Math.toRadians(-30),
                    roll: 0
                },
                duration: 2
            });
        }

        loadFix();
        setInterval(loadFix, 5000);
    </script>
</body>

</html>